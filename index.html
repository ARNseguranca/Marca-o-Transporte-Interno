<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Pontos de Ônibus Internos</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background-color: #4c8ad1;
      color: #000000;
    }

    header {
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, #ffffff, #ffffff);
      color: rgb(0, 0, 0);
      padding: 12px 20px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    header img {
      height: 45px;
      margin-right: 15px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
      font-weight: 600;
    }

    /* Banner de status de conexão */
    #statusBanner {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      text-align: center;
      padding: 8px;
      font-weight: bold;
      display: none; /* escondido por padrão */
      z-index: 2000;
    }

    #statusBanner.offline {
      background-color: #d9534f;
      color: white;
      display: block;
    }

    #statusBanner.online {
      background-color: #5cb85c;
      color: white;
      display: block;
    }

    #map {
      margin-top: 80px;
      height: calc(100vh - 80px);
      width: 100%;
    }

    /* Formulário de agendamento */
    #formAgendamento {
      position: fixed;
      top: 120px;
      right: 20px;
      background: white;
      border: 2px solid #0078d7;
      border-radius: 10px;
      padding: 20px;
      width: 250px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
      z-index: 1001;
    }

    #formAgendamento h3 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 1.1rem;
      color: #004aad;
    }

    #formAgendamento label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }

    #formAgendamento select,
    #formAgendamento input[type="text"] {
      width: 100%;
      padding: 6px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    #formAgendamento button {
      margin-top: 15px;
      background: #0078d7;
      color: white;
      border: none;
      padding: 8px;
      width: 100%;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    #formAgendamento button:hover {
      background: #004aad;
    }

    #closeForm {
      position: absolute;
      top: 8px;
      right: 10px;
      cursor: pointer;
      color: #0078d7;
      font-weight: bold;
    }

    /* Modal do vídeo obrigatório */
    #videoModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    #videoContainer {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 800px;
      width: 90%;
    }

    #videoContainer video {
      width: 100%;
      border-radius: 10px;
    }

    #btnVideoDone {
      margin-top: 10px;
      padding: 10px 20px;
      background: #0078d7;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    #btnVideoDone:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo-nascentes.jpg" alt="Logo">
    <h1>Mapa de Pontos de Ônibus</h1>
  </header>

  <!-- Banner de status -->
  <div id="statusBanner"></div>

  <div id="map"></div>

  <!-- Modal do vídeo obrigatório -->
  <div id="videoModal">
    <div id="videoContainer">
      <h2>Assista ao vídeo antes de agendar</h2>
      <video id="videoObrigatorio" controls>
        <source src="Transporte Interno ARN.mp4" type="video/mp4">
        Seu navegador não suporta vídeos HTML5.
      </video>
      <br>
      <button id="btnVideoDone" disabled>Liberar Agendamento</button>
    </div>
  </div>

  <!-- Formulário flutuante -->
  <div id="formAgendamento">
    <span id="closeForm">X</span>
    <h3>Agendar Ponto</h3>
    <form id="form" action="https://docs.google.com/forms/d/e/1FAIpQLSedg-XNufEu483TWf-WlAHpl4z8Fq-HEjH0XvOIhR6Y1YshOg/formResponse" method="POST" target="hidden_iframe">
      <label for="nome">Nome do Solicitante:</label>
      <input type="text" id="nome" name="entry.1813093835" required>

      <label for="ponto">Ponto:</label>
      <input type="text" id="ponto" name="entry.1553871928" readonly required>

      <label for="horario">Horário:</label>
      <select id="horario" name="entry.1757535250"></select>

      <button type="submit">Agendar</button>
    </form>
  </div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // -------------------- MAPA --------------------
    var map = L.map('map').setView([-19.99752, -43.92611], 17);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var busIcon = L.icon({
      iconUrl: 'Ponto.png',
      iconSize: [36, 36],
      iconAnchor: [18, 36],
      popupAnchor: [0, -36]
    });

    var pontos = [
      {nome: "PORTARIA", coords: [-19.9978072, -43.9266727]},
      {nome: "Ponto 30", coords: [-19.9977078, -43.9289372]},
      {nome: "Ponto 28", coords: [-19.9986592, -43.9306448]},
      {nome: "Ponto 29", coords: [-19.999421, -43.9326796]},
      {nome: "Ponto 27", coords: [-20.0002531, -43.9314901]},
      {nome: "Ponto 26", coords: [-20.0015469, -43.9333477]},
      {nome: "Ponto 24", coords: [-20.003258, -43.9296246]},
      {nome: "Ponto 25", coords: [-20.0050238, -43.9308419]},
      {nome: "Ponto 21", coords: [-20.0027213, -43.9338594]},
      {nome: "Ponto 22", coords: [-20.001474, -43.9355339]},
      {nome: "Ponto 23", coords: [-20.0031588, -43.9364208]},
      {nome: "Ponto 20", coords: [-20.0063663, -43.934352]},
      {nome: "Ponto 19", coords: [-20.0085746, -43.9318072]},
      {nome: "Ponto 17", coords: [-20.0104645, -43.9320381]},
      {nome: "Ponto 18", coords: [-20.0088433, -43.9343321]},
      {nome: "Ponto 12", coords: [-20.0088434, -43.9288248]},
      {nome: "Ponto 13", coords: [-20.0094456, -43.9269802]},
      {nome: "Ponto 14", coords: [-20.0075172, -43.9277972]},
      {nome: "Ponto 16", coords: [-20.0068404, -43.9290337]},
      {nome: "Ponto 15", coords: [-20.0079616, -43.9293497]},
      {nome: "Ponto 09", coords: [-20.0110997, -43.9309597]},
      {nome: "Ponto 10", coords: [-20.0120307, -43.9334509]},
      {nome: "Ponto 11", coords: [-20.0098192, -43.9337648]},
      {nome: "Ponto 08", coords: [-20.0102615, -43.9273848]},
      {nome: "Ponto 05", coords: [-20.0114455, -43.9257426]},
      {nome: "Ponto 06", coords: [-20.0112228, -43.9276231]},
      {nome: "Ponto 07", coords: [-20.0108785, -43.9296971]},
      {nome: "Ponto 04", coords: [-20.0068997, -43.9238609]},
      {nome: "Ponto 03", coords: [-20.0047577, -43.9260624]},
      {nome: "Ponto 02", coords: [-20.001753, -43.9270223]}
    ];

    var formBox = document.getElementById("formAgendamento");
    var pontoInput = document.getElementById("ponto");
    var closeBtn = document.getElementById("closeForm");

    closeBtn.onclick = function() {
      formBox.style.display = "none";
    }

    pontos.forEach(function(p) {
      L.marker(p.coords, {icon: busIcon})
        .addTo(map)
        .on('click', function() {
          pontoInput.value = p.nome;
          formBox.style.display = "block";
          preencherHorarios(p.nome);
        });
    });

    map.locate({setView: true, maxZoom: 17});

    function onLocationFound(e) {
      var radius = e.accuracy / 2;
      L.marker(e.latlng).addTo(map)
        .bindPopup("Você está aqui").openPopup();
      L.circle(e.latlng, radius).addTo(map);
    }

    function onLocationError(e) {
      alert("Não foi possível obter sua localização.");
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    // -------------------- FORMULÁRIO --------------------
    const horariosSelect = document.getElementById("horario");

    function preencherHorarios(ponto) {
      horariosSelect.innerHTML = "";
      const hoje = new Date();
      const dia = hoje.getDay();

      let horarios = [];
      if (dia >= 1 && dia <= 5) {
        horarios = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"];
      } else if (dia == 6) {
        if(ponto === "Ponto 13" || ponto === "Ponto 24") return;
        horarios = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00"];
      } else {
        horarios = ["08:00","12:00","14:00","16:00","18:00"];
      }

      horarios.forEach(function(h) {
        const option = document.createElement("option");
        option.value = h;
        option.textContent = h;
        horariosSelect.appendChild(option);
      });
    }

    document.getElementById("form").addEventListener("submit", function(e){
      e.preventDefault();

      if (!navigator.onLine) {
        alert("⚠️ Você está sem conexão com a internet. O agendamento não foi feito.");
        return;
      }

      this.submit();
      alert(
        "✅ Agendamento feito com sucesso!\n" +
        "Nome: " + document.getElementById("nome").value + "\n" +
        "Ponto: " + pontoInput.value + "\n" +
        "Horário: " + horariosSelect.value
      );
      formBox.style.display = "none";
      this.reset();
    });

    // -------------------- VÍDEO OBRIGATÓRIO --------------------
    const videoModal = document.getElementById("videoModal");
    const video = document.getElementById("videoObrigatorio");
    const btnVideoDone = document.getElementById("btnVideoDone");

    video.addEventListener("ended", function() {
      btnVideoDone.disabled = false;
    });

    btnVideoDone.addEventListener("click", function() {
      videoModal.style.display = "none";
    });

    // -------------------- STATUS DE CONEXÃO --------------------
    const statusBanner = document.getElementById("statusBanner");

    function atualizarStatus() {
      if (navigator.onLine) {
        statusBanner.textContent = "✅ Conexão restabelecida";
        statusBanner.className = "online";
        setTimeout(() => { statusBanner.style.display = "none"; }, 3000);
      } else {
        statusBanner.textContent = "⚠️ Sem conexão com a internet";
        statusBanner.className = "offline";
      }
    }

    window.addEventListener("online", atualizarStatus);
    window.addEventListener("offline", atualizarStatus);
    atualizarStatus();
  </script>
</body>
</html>

