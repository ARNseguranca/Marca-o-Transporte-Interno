<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4A769B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Nascentes - Transporte</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #phoneFrame {
            width: 100%;
            max-width: 390px;
            height: 844px;
            max-height: 95vh;
            background: #000;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 30px 100px rgba(0,0,0,0.8), 0 0 0 10px #2a2a2a, 0 0 0 12px #1a1a1a;
            position: relative;
        }

        #phoneFrame::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 28px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10000;
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s, visibility 0.4s;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        /* ========== TELA 1: BOAS-VINDAS ========== */
        #welcomeScreen {
            background: linear-gradient(135deg, #4A769B 0%, #3d6380 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 60px 30px 40px;
            text-align: center;
        }

        .logo-box {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            padding: 25px;
        }

        .logo-box img {
            width: 130%;
            height: 130%;
            object-fit: contain;
        }

        #welcomeScreen h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        #welcomeScreen p {
            font-size: 1rem;
            color: rgba(255,255,255,0.85);
            margin-bottom: 50px;
            line-height: 1.5;
        }

        .btn-primary {
            background: white;
            color: #4A769B;
            border: none;
            padding: 16px 50px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            transition: transform 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:active {
            transform: scale(0.95);
        }

        /* ========== TELA 2: REGRAS ========== */
        #rulesScreen {
            background: #0a0e12;
            display: flex;
            flex-direction: column;
        }

        .header-rules {
            background: linear-gradient(135deg, #4A769B 0%, #3d6380 100%);
            padding: 50px 20px 25px;
            text-align: center;
        }

        .header-rules h2 {
            font-size: 1.6rem;
            color: white;
            margin-bottom: 8px;
        }

        .header-rules p {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
        }

        .rules-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .rule-item {
            background: #131920;
            padding: 15px;
            border-radius: 14px;
            margin-bottom: 10px;
            display: flex;
            gap: 12px;
        }

        .rule-icon {
            width: 36px;
            height: 36px;
            background: rgba(74,118,155,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .rule-icon i {
            color: #7A9BB7;
            font-size: 1.1rem;
        }

        .rule-text {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.5;
            color: white;
        }

        .rule-text strong {
            color: #7A9BB7;
        }

        .rule-text a {
            color: #5CB3FF;
            text-decoration: none;
            font-weight: 600;
        }

        .voice-section {
            background: rgba(74,118,155,0.1);
            border: 2px solid #4A769B;
            padding: 18px;
            border-radius: 16px;
            margin: 20px 0;
        }

        .voice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .voice-header h3 {
            font-size: 1rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .switch {
            position: relative;
            width: 52px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            border-radius: 30px;
            transition: 0.3s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .slider {
            background: #00D9A3;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        .voice-desc {
            font-size: 0.85rem;
            color: #8e9aaf;
            line-height: 1.4;
        }

        .accept-box {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            padding: 16px;
            background: #131920;
            border-radius: 14px;
            border: 2px solid #4A769B;
        }

        .accept-box input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #4A769B;
        }

        .accept-box label {
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-continue {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00D9A3 0%, #00b386 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 1.05rem;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,217,163,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .btn-continue:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-continue:not(:disabled):active {
            transform: scale(0.98);
        }

        /* ========== TELA 3: MAPA ========== */
        #mapScreen {
            background: #0a0e12;
            display: flex;
            flex-direction: column;
        }

        .map-header {
            background: linear-gradient(135deg, #4A769B 0%, #3d6380 100%);
            padding: 50px 15px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-small {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px;
        }

        .logo-small img {
            width: 150%;
            height: 150%;
            object-fit: contain;
        }

        .header-title h1 {
            font-size: 0.95rem;
            color: white;
            font-weight: 700;
        }

        .header-title p {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.7);
        }

        .header-buttons {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:active {
            transform: scale(0.9);
        }

        .btn-icon.active {
            background: #00D9A3;
        }

        /* ===== BANNER STATUS √îNIBUS ===== */
        #busStatusBanner {
            background: linear-gradient(135deg, #FFB800 0%, #f59e0b 100%);
            padding: 12px 16px;
            display: none;
            align-items: center;
            justify-content: space-between;
            animation: slideDown 0.5s;
        }

        #busStatusBanner.show {
            display: flex;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .status-text {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #000;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .status-icon {
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1.5s infinite;
        }

        .btn-track-toggle {
            padding: 8px 16px;
            background: white;
            color: #FFB800;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-track-toggle:active {
            transform: scale(0.95);
        }

        .btn-track-toggle.tracking {
            background: #00D9A3;
            color: white;
        }

        #mapContainer {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .fab-group {
            position: absolute;
            bottom: 20px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 999;
        }

        .fab {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4A769B 0%, #3d6380 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(74,118,155,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            position: relative;
        }

        .fab:active {
            transform: scale(0.92);
        }

        .fab.voice-active {
            background: linear-gradient(135deg, #FF4757 0%, #c9302c 100%);
            animation: pulse 1.5s infinite;
        }

        /* Badge contador */
        .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #FF4757;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 900;
            border: 2px solid #0a0e12;
        }

        .fab-badge.show {
            display: flex;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 6px 18px rgba(255,71,87,0.5); }
            50% { box-shadow: 0 6px 28px rgba(255,71,87,0.8); }
        }

        #formSheet {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #131920;
            border-radius: 20px 20px 0 0;
            padding: 18px 18px 30px;
            transform: translateY(100%);
            transition: transform 0.4s;
            z-index: 1500;
            box-shadow: 0 -8px 30px rgba(0,0,0,0.6);
            max-height: 65%;
            overflow-y: auto;
        }

        #formSheet.show {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 35px;
            height: 4px;
            background: #666;
            border-radius: 2px;
            margin: 0 auto 18px;
        }

        .form-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }

        .form-title h3 {
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-close {
            width: 30px;
            height: 30px;
            background: #1a2330;
            border: none;
            border-radius: 50%;
            color: #999;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-field {
            margin-bottom: 15px;
        }

        .form-field label {
            display: block;
            font-size: 0.75rem;
            color: #8e9aaf;
            font-weight: 600;
            margin-bottom: 7px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .form-field input,
        .form-field select {
            width: 100%;
            padding: 13px 13px 13px 40px;
            background: #1a2330;
            border: 2px solid transparent;
            border-radius: 12px;
            color: white;
            font-size: 0.9rem;
            font-family: inherit;
            transition: border 0.3s;
        }

        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #4A769B;
        }

        .btn-mic {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            width: 34px;
            height: 34px;
            background: #4A769B;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .btn-mic.listening {
            background: #FF4757;
            animation: pulse 1.5s infinite;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4A769B 0%, #3d6380 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(74,118,155,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 18px;
            transition: transform 0.2s;
        }

        .btn-submit:active {
            transform: scale(0.98);
        }

        /* ===== MODAL NOTIFICA√á√ÉO PROXIMIDADE ===== */
        #proximityModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            padding: 20px;
        }

        #proximityModal.show {
            display: flex;
        }

        .proximity-card {
            background: linear-gradient(135deg, #FFB800 0%, #f59e0b 100%);
            border-radius: 24px;
            padding: 30px 24px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(255,184,0,0.5);
            animation: slideUp 0.5s;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .proximity-icon {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .proximity-card h2 {
            font-size: 1.6rem;
            color: #000;
            margin-bottom: 12px;
            font-weight: 800;
        }

        .proximity-card p {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .proximity-distance {
            font-size: 2rem;
            font-weight: 900;
            color: #000;
            margin: 16px 0 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .notification-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-notify {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn-notify:active {
            transform: scale(0.96);
        }

        .btn-notify-sound {
            background: white;
            color: #FFB800;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-notify-whatsapp {
            background: #25D366;
            color: white;
            box-shadow: 0 6px 20px rgba(37,211,102,0.4);
        }

        .btn-notify-close {
            background: rgba(0,0,0,0.3);
            color: white;
            margin-top: 8px;
        }

        /* ===== MODAL CHUVA PONTO 16 ===== */
        #rainyWeatherModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
            padding: 20px;
        }

        #rainyWeatherModal.show {
            display: flex;
        }

        .rainy-card {
            background: linear-gradient(135deg, #2E5C8A 0%, #1a3a52 100%);
            border-radius: 24px;
            padding: 30px 24px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(46,92,138,0.6);
            animation: slideUp 0.5s;
            border: 2px solid #4A769B;
        }

        .rainy-icon {
            width: 90px;
            height: 90px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            border: 3px solid #FFB800;
            animation: rainyBounce 2s infinite;
        }

        @keyframes rainyBounce {
            0%, 100% { transform: translateY(0) rotateZ(-5deg); }
            50% { transform: translateY(-15px) rotateZ(5deg); }
        }

        .rainy-card h2 {
            font-size: 1.8rem;
            color: #FFB800;
            margin-bottom: 15px;
            font-weight: 800;
        }

        .rainy-card p {
            font-size: 1rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 12px;
            font-weight: 600;
            line-height: 1.6;
        }

        .rainy-warning {
            background: rgba(255,184,0,0.2);
            border: 2px solid #FFB800;
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
            color: #FFB800;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .rainy-instructions {
            background: rgba(74,118,155,0.3);
            border-left: 4px solid #4A769B;
            padding: 14px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: left;
            font-size: 0.95rem;
            color: rgba(255,255,255,0.85);
            line-height: 1.6;
        }

        .btn-rainy-continue {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #00D9A3 0%, #00b386 100%);
            color: #000;
            border: none;
            border-radius: 16px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 24px;
            transition: transform 0.2s;
        }

        .btn-rainy-continue:active {
            transform: scale(0.96);
        }

        .toast {
            position: absolute;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: #131920;
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 4000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.5s;
            max-width: 85%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success { background: #00D9A3; }
        .toast.error { background: #FF4757; }
        .toast.warning { background: #FFB800; }

        .loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .loading.show {
            display: flex;
        }

        .spinner {
            width: 45px;
            height: 45px;
            border: 4px solid rgba(74,118,155,0.2);
            border-top-color: #4A769B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .leaflet-popup-content-wrapper {
            background: #131920;
            color: white;
            border-radius: 12px;
            border: 2px solid #4A769B;
        }

        .leaflet-popup-content {
            margin: 8px;
            font-weight: 600;
        }

        .leaflet-popup-tip {
            background: #131920;
        }

        @media (max-width: 450px) {
            body {
                padding: 0;
            }
            #phoneFrame {
                max-width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
            #phoneFrame::before {
                display: none;
            }
        }
    </style>
    <!-- PWA META TAGS -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4A769B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nascentes">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

<!-- REGISTRAR SERVICE WORKER -->
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').then(reg => {
            console.log('‚úÖ Service Worker registrado');
        }).catch(err => {
            console.log('‚ùå Erro ao registrar Service Worker:', err);
        });
    }
</script>
</head>
<body>
    <div id="phoneFrame">
        <!-- TELA 1: BOAS-VINDAS -->
        <div id="welcomeScreen" class="screen active">
            <div class="logo-box">
                <img src="Logotipo1.png" alt="Logo">
            </div>
            <h1>Bem-vindo ao<br>Nascentes Vale dos Cristais</h1>
            <p>Sistema de Marca√ß√£o de<br>Pontos de √înibus Internos</p>
            <button class="btn-primary" onclick="goToRules()">
                Continuar
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <!-- TELA 2: REGRAS -->
        <div id="rulesScreen" class="screen">
            <div class="header-rules">
                <h2>üìã Regras de Uso</h2>
                <p>Leia atentamente antes de continuar</p>
            </div>
            <div class="rules-body">
                <div class="rule-item">
                    <div class="rule-icon"><i class="fas fa-clock"></i></div>
                    <div class="rule-text">
                        Solicite com <strong>at√© 10 minutos de anteced√™ncia</strong> do hor√°rio da van
                    </div>
                </div>
                <div class="rule-item">
                    <div class="rule-icon"><i class="fas fa-ban"></i></div>
                    <div class="rule-text">
                        Agendamento <strong>fora do hor√°rio n√£o ser√° atendido</strong>
                    </div>
                </div>
                <div class="rule-item">
                    <div class="rule-icon"><i class="fas fa-calendar-day"></i></div>
                    <div class="rule-text">
                        Marca√ß√£o apenas para o <strong>ponto e dia do embarque</strong>
                    </div>
                </div>
                <div class="rule-item">
                    <div class="rule-icon"><i class="fas fa-redo"></i></div>
                    <div class="rule-text">
                        <strong>Novo agendamento a cada dia</strong>, mesmo para o mesmo ponto
                    </div>
                </div>
                <div class="rule-item">
                    <div class="rule-icon"><i class="fas fa-phone"></i></div>
                    <div class="rule-text">
                        Sem energia/internet, ligue: <a href="tel:+5531983908024"><strong>(31) 9 8390-8024</strong></a>
                    </div>
                </div>

                <div class="voice-section">
                    <div class="voice-header">
                        <h3><i class="fas fa-microphone"></i> Assistente de Voz</h3>
                        <label class="switch">
                            <input type="checkbox" id="voiceToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <p class="voice-desc">Ative para receber instru√ß√µes por voz e usar comandos falados</p>
                </div>

                <div class="accept-box">
                    <input type="checkbox" id="acceptCheck">
                    <label for="acceptCheck">Li e aceito todas as regras</label>
                </div>

                <button class="btn-continue" id="btnGoMap" disabled>
                    <i class="fas fa-map-marked-alt"></i>
                    Acessar o Mapa
                </button>
            </div>
        </div>

        <!-- TELA 3: MAPA -->
        <div id="mapScreen" class="screen">
            <div class="map-header">
                <div class="header-left">
                    <div class="logo-small">
                        <img src="Logo site.png" alt="Logo">
                    </div>
                    <div class="header-title">
                        <h1>Nascentes</h1>
                        <p>Transporte Interno</p>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="btn-icon" id="btnVoiceToggle">
                        <i class="fas fa-microphone-slash"></i>
                    </button>
                    <button class="btn-icon" onclick="backToRules()">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>

            <!-- BANNER STATUS √îNIBUS -->
            <div id="busStatusBanner">
                <div class="status-text">
                    <div class="status-icon">üöå</div>
                    <span id="statusMessage">Aguardando rota...</span>
                </div>
                <button class="btn-track-toggle" id="btnTrackToggle" onclick="toggleBusTracking()">
                    <i class="fas fa-eye"></i>
                    <span>Ver √înibus</span>
                </button>
            </div>

            <div id="mapContainer">
                <div id="map"></div>
                
                <div class="fab-group">
                    <button class="fab" id="btnLocation" title="Minha localiza√ß√£o">
                        <i class="fas fa-location-crosshairs"></i>
                    </button>
                    <button class="fab" id="btnBusLocation" onclick="toggleBusTracking()" title="Rastrear √¥nibus">
                        <i class="fas fa-bus"></i>
                        <div class="fab-badge" id="busNotification">!</div>
                    </button>
                    <button class="fab" id="btnVoice">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>

                <div id="formSheet">
                    <div class="sheet-handle"></div>
                    <div class="form-title">
                        <h3><i class="fas fa-bus"></i> Agendar Ponto</h3>
                        <button class="btn-close" id="btnCloseForm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <form id="agendamentoForm" action="https://docs.google.com/forms/d/e/1FAIpQLSedg-XNufEu483TWf-WlAHpl4z8Fq-HEjH0XvOIhR6Y1YshOg/formResponse" method="POST" target="hiddenFrame">
                        <div class="form-field">
                            <label>Nome</label>
                            <div class="input-group">
                                <i class="input-icon fas fa-user"></i>
                                <input type="text" id="nomeInput" name="entry.1813093835" placeholder="Seu nome completo" required>
                                <button type="button" class="btn-mic" onclick="voiceInput('nomeInput')">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Ponto</label>
                            <div class="input-group">
                                <i class="input-icon fas fa-map-marker-alt"></i>
                                <input type="text" id="pontoInput" name="entry.1553871928" readonly required>
                            </div>
                        </div>
                        <div class="form-field">
                            <label>Hor√°rio</label>
                            <div class="input-group">
                                <i class="input-icon fas fa-clock"></i>
                                <select id="horarioSelect" name="entry.1757535250" required>
                                    <option value="">Selecione</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-submit">
                            <i class="fas fa-check-circle"></i>
                            Confirmar Agendamento
                        </button>
                    </form>
                </div>

                <!-- MODAL DE PROXIMIDADE -->
                <div id="proximityModal">
                    <div class="proximity-card">
                        <div class="proximity-icon">üöå</div>
                        <h2>√înibus se aproximando!</h2>
                        <p>O √¥nibus est√° pr√≥ximo do seu ponto:</p>
                        <div class="proximity-distance" id="proximityDistance">300m</div>
                        <p style="font-size:0.9rem; margin-top:-12px;"><strong id="proximityPoint">Ponto XX</strong></p>
                        
                        <div class="notification-options">
                            <button class="btn-notify btn-notify-sound" onclick="playNotificationSound()">
                                <i class="fas fa-volume-up"></i>
                                Tocar Alerta Sonoro
                            </button>
                            <button class="btn-notify btn-notify-whatsapp" onclick="sendWhatsAppNotification()">
                                <i class="fab fa-whatsapp"></i>
                                Enviar Aviso no WhatsApp
                            </button>
                            <button class="btn-notify btn-notify-close" onclick="closeProximityAlert()">
                                OK, Entendi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MODAL CHUVA PONTO 16 -->
                <div id="rainyWeatherModal">
                    <div class="rainy-card">
                        <div class="rainy-icon">‚õàÔ∏è</div>
                        <h2>Em dias de Chuva</h2>
                        <p>O <strong>Ponto 16</strong> estar√° temporariamente indispon√≠vel</p>
                        
                        <div class="rainy-warning">
                            ‚ö†Ô∏è Por quest√µes de seguran√ßa
                        </div>

                        <div class="rainy-instructions">
                            <p><strong>Motivo:</strong> A subida √© ingrime e coloca em risco o ve√≠culo voltar durante o per√≠odo de chuva.</p>
                            <p style="margin-top: 12px;"><strong>Solu√ß√£o:</strong> Aguarde a melhoria das condi√ß√µes clim√°ticas ou dirija-se para o <strong>Ponto 14</strong>, que disp√µe de melhor acesso.</p>
                            <p style="margin-top: 12px; font-style: italic;">Contamos com a sua colabora√ß√£o e compreens√£o!</p>
                        </div>

                        <button class="btn-rainy-continue" onclick="continueWithPoint16()">
                            <i class="fas fa-check-circle"></i>
                            Continuar Agendamento
                        </button>
                    </div>
                </div>

                <div class="toast" id="toast">
                    <i class="fas fa-check-circle"></i>
                    <span id="toastMsg"></span>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // ===== CONFIGURA√á√ÉO DO BACKEND =====
        const TRACKING_URL = 'https://script.google.com/macros/s/AKfycbz3Ze73XTRYXuAt7Foe_ymeVJvKEA1RZ7r2Jd8L8pC0j3jl0lPpqdC96CYdSxIZWYtD/exec';

        let map, userMarker, busTrackingMarker;
        let voiceEnabled = false;
        let voiceActive = false;
        let recognition;
        let targetInput = null;
        const synth = window.speechSynthesis;

        // Vari√°veis de rastreamento
        let proximityAlerted = {};
        let userPosition = null;
        let scheduledPoint = null;
        let watchPositionId = null;
        let trackingInterval = null;
        let busTrackingEnabled = false;
        let routeStarted = false;
        let pendingPoint = null;

        const pontos = [
            {nome:"PORTARIA",coords:[-19.9978072,-43.9266727]},
            {nome:"Ponto 30",coords:[-19.9977078,-43.9289372]},
            {nome:"Ponto 28",coords:[-19.9986592,-43.9306448]},
            {nome:"Ponto 29",coords:[-19.999421,-43.9326796]},
            {nome:"Ponto 27",coords:[-20.0002531,-43.9314901]},
            {nome:"Ponto 26",coords:[-20.0015469,-43.9333477]},
            {nome:"Ponto 24",coords:[-20.003258,-43.9296246]},
            {nome:"Ponto 25",coords:[-20.0050238,-43.9308419]},
            {nome:"Ponto 21",coords:[-20.0027213,-43.9338594]},
            {nome:"Ponto 22",coords:[-20.001474,-43.9355339]},
            {nome:"Ponto 23",coords:[-20.0031588,-43.9364208]},
            {nome:"Ponto 20",coords:[-20.0063663,-43.934352]},
            {nome:"Ponto 19",coords:[-20.0085746,-43.9318072]},
            {nome:"Ponto 17",coords:[-20.0104645,-43.9320381]},
            {nome:"Ponto 18",coords:[-20.0088433,-43.9343321]},
            {nome:"Ponto 12",coords:[-20.0088434,-43.9288248]},
            {nome:"Ponto 13",coords:[-20.0094456,-43.9269802]},
            {nome:"Ponto 14",coords:[-20.0075172,-43.9277972]},
            {nome:"Ponto 16",coords:[-20.0068404,-43.9290337]},
            {nome:"Ponto 15",coords:[-20.0079616,-43.9293497]},
            {nome:"Ponto 09",coords:[-20.0110997,-43.9309597]},
            {nome:"Ponto 10",coords:[-20.0120307,-43.9334509]},
            {nome:"Ponto 11",coords:[-20.0098192,-43.9337648]},
            {nome:"Ponto 08",coords:[-20.0102615,-43.9273848]},
            {nome:"Ponto 05",coords:[-20.0114455,-43.9257426]},
            {nome:"Ponto 06",coords:[-20.0112228,-43.9276231]},
            {nome:"Ponto 07",coords:[-20.0108785,-43.9296971]},
            {nome:"Ponto 04",coords:[-20.0068997,-43.9238609]},
            {nome:"Ponto 03",coords:[-20.0047577,-43.9260624]},
            {nome:"Ponto 02",coords:[-20.001753,-43.9270223]}
        ];

        // ===== RASTREAMENTO DO √îNIBUS =====
        function toggleBusTracking() {
            busTrackingEnabled = !busTrackingEnabled;
            
            const btn = document.getElementById('btnTrackToggle');
            const btnIcon = btn.querySelector('i');
            const btnText = btn.querySelector('span');
            const fabBtn = document.getElementById('btnBusLocation');
            
            if (busTrackingEnabled) {
                btn.classList.add('tracking');
                btnIcon.className = 'fas fa-eye-slash';
                btnText.textContent = 'Ocultar';
                fabBtn.classList.add('voice-active');
                startBusTracking();
                showToast('Rastreamento do √¥nibus ativado', 'success');
                vibrate(100);
            } else {
                btn.classList.remove('tracking');
                btnIcon.className = 'fas fa-eye';
                btnText.textContent = 'Ver √înibus';
                fabBtn.classList.remove('voice-active');
                stopBusTracking();
                showToast('Rastreamento desativado', 'info');
                vibrate(50);
            }
        }

        // Iniciar rastreamento cont√≠nuo
        function startBusTracking() {
            if (trackingInterval) {
                return;
            }
            
            fetchBusLocation();
            trackingInterval = setInterval(() => {
                fetchBusLocation();
            }, 5000);
        }

        // Parar rastreamento
        function stopBusTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (busTrackingMarker && map) {
                map.removeLayer(busTrackingMarker);
                busTrackingMarker = null;
            }
        }

        // Buscar localiza√ß√£o do √¥nibus
        async function fetchBusLocation() {
            if (!busTrackingEnabled) {
                return;
            }
            
            try {
                const response = await fetch(TRACKING_URL + '?action=getLocation');
                const data = await response.json();
                
                if (data.active) {
                    updateBusMarker(data.latitude, data.longitude, data.bearing);
                    
                    const myScheduledTime = document.getElementById('horarioSelect').value;
                    if (myScheduledTime && data.horario === myScheduledTime) {
                        if (userPosition) {
                            const distance = calculateDistance(
                                data.latitude,
                                data.longitude,
                                userPosition.lat,
                                userPosition.lng
                            );
                            
                            if (distance <= 300 && !proximityAlerted[scheduledPoint]) {
                                proximityAlerted[scheduledPoint] = true;
                                showProximityAlert(scheduledPoint, Math.round(distance));
                            }
                        }
                    }
                } else {
                    if (busTrackingMarker && map) {
                        map.removeLayer(busTrackingMarker);
                        busTrackingMarker = null;
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar localiza√ß√£o do √¥nibus:', error);
            }
        }

        // Atualizar marcador do √¥nibus
        function updateBusMarker(lat, lng, bearing) {
            if (!map) {
                return;
            }
            
            if (!busTrackingMarker) {
                const busIcon = L.divIcon({
                    className: 'bus-tracking-marker',
                    html: `<div style="width:45px; height:45px; transform:rotate(${bearing}deg); transition:transform 0.5s ease-out">
                            <svg viewBox="0 0 24 24" fill="#FFB800" style="filter:drop-shadow(0 4px 15px rgba(255,184,0,0.8))">
                                <path d="M12,2C8.69,2 6,4.69 6,8C6,12.5 12,19 12,19C12,19 18,12.5 18,8C18,4.69 15.31,2 12,2M12,11A3,3 0 0,1 9,8A3,3 0 0,1 12,5A3,3 0 0,1 15,8A3,3 0 0,1 12,11M12,6.5A1.5,1.5 0 0,0 10.5,8A1.5,1.5 0 0,0 12,9.5A1.5,1.5 0 0,0 13.5,8A1.5,1.5 0 0,0 12,6.5Z" />
                            </svg>
                           </div>`,
                    iconSize: [45, 45],
                    iconAnchor: [22, 45]
                });
                
                busTrackingMarker = L.marker([lat, lng], {
                    icon: busIcon,
                    draggable: false
                }).addTo(map);
                
                busTrackingMarker.bindPopup('üöå √înibus em rota');
            } else {
                busTrackingMarker.setLatLng([lat, lng]);
                const el = busTrackingMarker.getElement();
                if (el) {
                    const div = el.querySelector('div');
                    if (div) {
                        div.style.transform = `rotate(${bearing}deg)`;
                    }
                }
            }
        }

        // Verificar status da rota
        async function checkRouteStatus() {
            try {
                const response = await fetch(TRACKING_URL + '?action=getRouteStatus');
                const data = await response.json();
                
                if (data.active && !routeStarted) {
                    routeStarted = true;
                    const myScheduledTime = document.getElementById('horarioSelect').value;
                    
                    if (myScheduledTime && data.horario === myScheduledTime) {
                        showRouteStartedNotification(data.horario);
                    }
                } else if (!data.active && routeStarted) {
                    routeStarted = false;
                    document.getElementById('busStatusBanner').classList.remove('show');
                }
            } catch (error) {
                console.error('Erro ao verificar status da rota:', error);
            }
        }

        // Mostrar notifica√ß√£o de rota iniciada
        function showRouteStartedNotification(horario) {
            document.getElementById('statusMessage').textContent = `Seu √¥nibus iniciou a rota! (${horario})`;
            document.getElementById('busStatusBanner').classList.add('show');
            document.getElementById('busNotification').classList.add('show');
            
            showToast(`üöå √înibus do hor√°rio ${horario} iniciou a rota!`, 'warning');
            vibrate([200, 100, 200]);
            
            if (voiceEnabled) {
                speak(`Aten√ß√£o! O √¥nibus do hor√°rio ${horario} iniciou a rota`);
            }
        }

        // ===== CALCULAR DIST√ÇNCIA =====
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ===== VERIFICAR PROXIMIDADE =====
        function checkProximity() {
            if (!userPosition || !scheduledPoint) {
                return;
            }

            const ponto = pontos.find(p => p.nome === scheduledPoint);
            if (!ponto) {
                return;
            }

            const distance = calculateDistance(
                userPosition.lat,
                userPosition.lng,
                ponto.coords[0],
                ponto.coords[1]
            );

            if (distance <= 300 && !proximityAlerted[scheduledPoint]) {
                proximityAlerted[scheduledPoint] = true;
                showProximityAlert(scheduledPoint, Math.round(distance));
            }
        }

        // ===== ALERTA DE PROXIMIDADE =====
        function showProximityAlert(pointName, distance) {
            document.getElementById('proximityPoint').textContent = pointName;
            document.getElementById('proximityDistance').textContent = distance + 'm';
            document.getElementById('proximityModal').classList.add('show');
            
            playNotificationSound();
            vibrate([200, 100, 200, 100, 200]);
            
            if (voiceEnabled) {
                speak(`Aten√ß√£o! O √¥nibus est√° a ${distance} metros do ${pointName}. Prepare-se para embarcar!`);
            }
        }

        function playNotificationSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, i * 400);
            }
            
            showToast('Alerta sonoro tocado!', 'success');
            vibrate(100);
        }

        function sendWhatsAppNotification() {
            const pointName = document.getElementById('proximityPoint').textContent;
            const distance = document.getElementById('proximityDistance').textContent;
            const message = `üöå *√îNIBUS CHEGANDO!*\n\nO √¥nibus est√° a ${distance} do *${pointName}*.\n\nPrepare-se para embarcar!\n\n_Nascentes Vale dos Cristais_`;
            
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
            
            showToast('Abrindo WhatsApp...', 'success');
            vibrate(50);
        }

        function closeProximityAlert() {
            document.getElementById('proximityModal').classList.remove('show');
        }

        // ===== ALERTA CHUVA PONTO 16 =====
        function showRainyAlert() {
            document.getElementById('rainyWeatherModal').classList.add('show');
            
            showToast('‚ö†Ô∏è Aviso: Ponto 16 com acesso em risco', 'warning');
            vibrate([300, 150, 300]);
            
            if (voiceEnabled) {
                speak('Aten√ß√£o! O Ponto 16 encontra-se temporariamente indispon√≠vel por quest√µes de seguran√ßa durante o per√≠odo de chuva');
            }
        }

        function continueWithPoint16() {
            document.getElementById('rainyWeatherModal').classList.remove('show');
            
            if (pendingPoint) {
                scheduledPoint = pendingPoint;
                proximityAlerted[pendingPoint] = false;
                document.getElementById('pontoInput').value = pendingPoint;
                fillHorarios(pendingPoint);
                showForm();
                speak(`${pendingPoint} selecionado`);
                vibrate(50);
                pendingPoint = null;
            }
        }

        // ===== NAVEGA√á√ÉO =====
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            vibrate(50);
        }

        function goToRules() {
            showScreen('rulesScreen');
        }

        function goToMap() {
            showScreen('mapScreen');
            setTimeout(() => {
                if (!map) {
                    initMap();
                }
                map.invalidateSize();
                startLocationTracking();
                checkRouteStatus();
                setInterval(checkRouteStatus, 10000);
            }, 100);
        }

        function backToRules() {
            showScreen('rulesScreen');
            if (watchPositionId) {
                navigator.geolocation.clearWatch(watchPositionId);
                watchPositionId = null;
            }
            stopBusTracking();
        }

        // ===== TRACKING LOCALIZA√á√ÉO DO PASSAGEIRO =====
        function startLocationTracking() {
            if (!navigator.geolocation) {
                return;
            }

            watchPositionId = navigator.geolocation.watchPosition(
                (position) => {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const icon = L.icon({
                        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/marker/img/marker-icon-blue.png",
                        iconSize: [25,41],
                        iconAnchor: [12,41]
                    });

                    if (userMarker) {
                        userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                    } else {
                        userMarker = L.marker([userPosition.lat, userPosition.lng], {icon})
                            .addTo(map).bindPopup('üìç Voc√™ est√° aqui');
                    }

                    checkProximity();
                },
                (error) => {
                    console.error('Erro GPS:', error);
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 10000
                }
            );
        }

        // ===== VOZ =====
        function speak(text) {
            if (!voiceEnabled) {
                return;
            }
            synth.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            synth.speak(utterance);
        }

        function initVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                return;
            }
            recognition = new window.webkitSpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;

            recognition.onresult = (e) => {
                const text = e.results[0][0].transcript;
                if (targetInput) {
                    document.getElementById(targetInput).value = text;
                    targetInput = null;
                    showToast('Texto capturado!', 'success');
                } else {
                    handleCommand(text);
                }
            };

            recognition.onend = () => {
                if (voiceActive) {
                    setTimeout(() => recognition.start(), 500);
                }
            };
        }

        function voiceInput(field) {
            if (!recognition) {
                return;
            }
            targetInput = field;
            recognition.start();
            speak('Diga o texto');
            vibrate(100);
        }

        function toggleVoice() {
            if (!voiceEnabled) {
                showToast('Ative a voz nas regras primeiro', 'warning');
                return;
            }

            voiceActive = !voiceActive;
            const btn = document.getElementById('btnVoice');
            const icon = document.getElementById('btnVoiceToggle').querySelector('i');

            if (voiceActive) {
                btn.classList.add('voice-active');
                icon.className = 'fas fa-microphone';
                document.getElementById('btnVoiceToggle').classList.add('active');
                if (recognition) {
                    recognition.start();
                }
                speak('Assistente ativado');
                vibrate([100,50,100]);
            } else {
                btn.classList.remove('voice-active');
                icon.className = 'fas fa-microphone-slash';
                document.getElementById('btnVoiceToggle').classList.remove('active');
                if (recognition) {
                    recognition.stop();
                }
                speak('Assistente desativado');
                vibrate(50);
            }
        }

        function handleCommand(cmd) {
            cmd = cmd.toLowerCase();
            if (cmd.includes('localiza√ß√£o') || cmd.includes('onde')) {
                requestLocation();
            } else if (cmd.includes('regras')) {
                backToRules();
            } else if (cmd.includes('fechar')) {
                hideForm();
            } else if (cmd.includes('√¥nibus')) {
                toggleBusTracking();
            }
        }

        // ===== MAPA =====
        function initMap() {
            map = L.map('map').setView([-19.99752, -43.92611], 17);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            const icon = L.icon({
                iconUrl: 'Ponto.png',
                iconSize: [36,36],
                iconAnchor: [18,36],
                popupAnchor: [0,-36]
            });

            pontos.forEach(p => {
                L.marker(p.coords, {icon}).addTo(map).on('click', () => selectPonto(p.nome));
            });
        }

        function selectPonto(nome) {
            const dia = new Date().getDay();
            if (dia === 6 && (nome === "Ponto 13" || nome === "Ponto 24")) {
                showToast('Aos s√°bados este ponto n√£o precisa agendar', 'warning');
                speak('Aos s√°bados n√£o √© necess√°rio agendar este ponto');
                vibrate([200,100,200]);
                return;
            }

            // VERIFICAR SE √â PONTO 16 E MOSTRAR AVISO
            if (nome === "Ponto 16") {
                pendingPoint = nome;
                showRainyAlert();
                return;
            }

            scheduledPoint = nome;
            proximityAlerted[nome] = false;

            document.getElementById('pontoInput').value = nome;
            fillHorarios(nome);
            showForm();
            speak(`${nome} selecionado`);
            vibrate(50);
        }

        function fillHorarios(ponto) {
            const select = document.getElementById('horarioSelect');
            select.innerHTML = '<option value="">Selecione</option>';

            const dia = new Date().getDay();
            let horarios = [];

            if (dia >= 1 && dia <= 5) {
                horarios = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00"];
            } else if (dia === 6) {
                if (ponto === "Ponto 13" || ponto === "Ponto 24") {
                    return;
                }
                horarios = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00"];
            } else {
                horarios = ["08:00","12:00","14:00","16:00","18:00"];
            }

            horarios.forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                select.appendChild(opt);
            });
        }

        function requestLocation() {
            if (!navigator.geolocation) {
                showToast('Geolocaliza√ß√£o n√£o dispon√≠vel', 'error');
                return;
            }

            showLoading(true);
            speak('Obtendo localiza√ß√£o');

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userPosition = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude
                    };

                    const icon = L.icon({
                        iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
                        iconSize: [25,41],
                        iconAnchor: [12,41]
                    });

                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([userPosition.lat, userPosition.lng], {icon})
                        .addTo(map).bindPopup('üìç Voc√™ est√° aqui').openPopup();

                    map.setView([userPosition.lat, userPosition.lng], 17);
                    showLoading(false);
                    showToast('Localiza√ß√£o encontrada', 'success');
                    speak('Localiza√ß√£o encontrada');
                    vibrate(100);
                },
                () => {
                    showLoading(false);
                    showToast('N√£o foi poss√≠vel obter localiza√ß√£o', 'error');
                    speak('Erro ao obter localiza√ß√£o. Ative o GPS');
                    vibrate([100,50,100]);
                }
            );
        }

        // ===== FORMUL√ÅRIO =====
        function showForm() {
            document.getElementById('formSheet').classList.add('show');
        }

        function hideForm() {
            document.getElementById('formSheet').classList.remove('show');
        }

        // ===== UTILIDADES =====
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMsg');
            const icon = toast.querySelector('i');

            toast.className = `toast ${type}`;
            msgEl.textContent = msg;

            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                icon.className = 'fas fa-exclamation-circle';
            } else {
                icon.className = 'fas fa-exclamation-triangle';
            }

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // ===== EVENTOS =====
        document.getElementById('voiceToggle').addEventListener('change', (e) => {
            voiceEnabled = e.target.checked;
            const icon = document.getElementById('btnVoiceToggle').querySelector('i');
            icon.className = voiceEnabled ? 'fas fa-microphone' : 'fas fa-microphone-slash';
            if (voiceEnabled) {
                speak('Assistente de voz ativado');
                vibrate(100);
            }
        });

        document.getElementById('acceptCheck').addEventListener('change', (e) => {
            document.getElementById('btnGoMap').disabled = !e.target.checked;
        });

        document.getElementById('btnGoMap').addEventListener('click', goToMap);
        document.getElementById('btnLocation').addEventListener('click', requestLocation);
        document.getElementById('btnVoice').addEventListener('click', toggleVoice);
        document.getElementById('btnVoiceToggle').addEventListener('click', toggleVoice);
        document.getElementById('btnCloseForm').addEventListener('click', hideForm);

        document.getElementById('agendamentoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!navigator.onLine) {
                showToast('Sem internet', 'error');
                speak('Sem conex√£o com a internet');
                vibrate([200,100,200]);
                return;
            }

            showLoading(true);
            e.target.submit();

            setTimeout(() => {
                showLoading(false);
                showToast('Agendamento confirmado!', 'success');
                speak('Agendamento confirmado com sucesso. Voc√™ ser√° avisado quando o √¥nibus se aproximar.');
                vibrate([100,50,100,50,100]);
                hideForm();
            }, 1500);
        });

        // ===== INIT =====
        initVoice();
    </script>
</body>
</html>
